# Payment Module Architecture Diagrams

## ðŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Next.js)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Order Page      â”‚  â”‚  Payment Button  â”‚  â”‚  Success Page    â”‚ â”‚
â”‚  â”‚  - Show order    â”‚  â”‚  - Initiate      â”‚  â”‚  - Confirm       â”‚ â”‚
â”‚  â”‚  - Pay button    â”‚  â”‚  - Razorpay SDK  â”‚  â”‚  - Order status  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ HTTP/S
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BACKEND (Express.js)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      PAYMENT MODULE                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  routes.js   â”‚  â”‚  service.js  â”‚  â”‚  razorpay.client â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Thin HTTP â”‚  â”‚  - Business  â”‚  â”‚  - SDK wrapper   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Validate  â”‚  â”‚  - DB ops    â”‚  â”‚  - Signature     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Response  â”‚  â”‚  - Logic     â”‚  â”‚  - Orders API    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      DATABASE (MongoDB)                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  Order       â”‚  â”‚  Payment     â”‚  â”‚  User            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Collection  â”‚  â”‚  Collection  â”‚  â”‚  Collection      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Razorpay API
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RAZORPAY (Payment Gateway)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Orders API  â”‚  â”‚  Payments    â”‚  â”‚  Webhooks                â”‚ â”‚
â”‚  â”‚  - Create    â”‚  â”‚  - Process   â”‚  â”‚  - payment.captured      â”‚ â”‚
â”‚  â”‚  - Fetch     â”‚  â”‚  - Verify    â”‚  â”‚  - payment.failed        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ”„ Payment Flow Sequence

```
BUYER                   FRONTEND                BACKEND                 RAZORPAY
  |                        |                       |                       |
  â”œâ”€[Click "Pay Now"]â”€â”€â”€â”€â”€>|                       |                       |
  |                        |                       |                       |
  |                        â”œâ”€â”€[POST /create]â”€â”€â”€â”€â”€â”€>|                       |
  |                        |   {orderId}           |                       |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Validate Order]â”€â”€â”€â”€â”€|
  |                        |                       â”œâ”€â”€[Get Amount]â”€â”€â”€â”€â”€â”€â”€â”€â”€|
  |                        |                       |   from Order          |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Create Order]â”€â”€â”€â”€â”€â”€>|
  |                        |                       |   {amount, currency}  |
  |                        |                       |<â”€â”€[Order ID]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Save Payment]â”€â”€â”€â”€â”€â”€â”€|
  |                        |                       |   status: created     |
  |                        |<â”€â”€[Order ID]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       |
  |                        |   {razorpayOrderId}   |                       |
  |                        |                       |                       |
  |                        â”œâ”€â”€[Open Checkout]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>|
  |                        |   Razorpay Modal                              |
  |                        |                       |                       |
  â”œâ”€[Enter Payment Info]â”€â”€>|                       |                       |
  â”œâ”€[UPI/Card/NetBanking]â”€>|                       |                       |
  |                        |                       |                       |
  |                        |                       |        [Process]      |
  |                        |                       |        [Authorize]    |
  |                        |                       |        [Capture]      |
  |                        |<â”€â”€[Success Callback]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  |                        |   {payment_id, signature}                    |
  |                        |                       |                       |
  |                        â”œâ”€â”€[POST /verify]â”€â”€â”€â”€â”€â”€>|                       |
  |                        |   {signature}         |                       |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Verify Signature]â”€â”€â”€|
  |                        |                       |   HMAC SHA256         |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Fetch Payment]â”€â”€â”€â”€â”€>|
  |                        |                       |<â”€â”€[Payment Details]â”€â”€â”€â”¤
  |                        |                       |   status: captured    |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Update Payment]â”€â”€â”€â”€â”€|
  |                        |                       |   status: paid        |
  |                        |                       â”œâ”€â”€[Update Order]â”€â”€â”€â”€â”€â”€â”€|
  |                        |                       |   paymentStatus: paid |
  |                        |<â”€â”€[Success]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       |
  |                        |                       |                       |
  â”œâ”€[Redirect to Success]â”€>|                       |                       |
  |                        |                       |                       |
  |                        |                       |<â”€â”€[Webhook]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  |                        |                       |   payment.captured    |
  |                        |                       |                       |
  |                        |                       â”œâ”€â”€[Verify Webhook]â”€â”€â”€â”€â”€|
  |                        |                       â”œâ”€â”€[Update DB]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|
  |                        |                       |   (idempotent)        |
  |                        |                       â”œâ”€â”€[Return 200]â”€â”€â”€â”€â”€â”€â”€â”€>|
  |                        |                       |                       |
```

## ðŸ“Š Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ORDER (Business Truth)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  buyerId: ObjectId                                        â”‚  â”‚
â”‚  â”‚  sellerId: ObjectId                                       â”‚  â”‚
â”‚  â”‚  items: [...]                                             â”‚  â”‚
â”‚  â”‚  totalAmount: 1500.00  â—„â”€â”€â”€ SOURCE OF TRUTH              â”‚  â”‚
â”‚  â”‚  paymentStatus: "pending" â”€â”€â”€â”                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Links to
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAYMENT (Financial Event)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  orderId: ObjectId â—„â”€â”€â”€ REQUIRED LINK                    â”‚  â”‚
â”‚  â”‚  buyerId: ObjectId                                        â”‚  â”‚
â”‚  â”‚  razorpayOrderId: "order_Nxxx" â—„â”€â”€â”€ UNIQUE               â”‚  â”‚
â”‚  â”‚  razorpayPaymentId: "pay_Nxxx"                           â”‚  â”‚
â”‚  â”‚  amount: 1500.00 â—„â”€â”€â”€ FROM ORDER                         â”‚  â”‚
â”‚  â”‚  status: "created" â†’ "paid" â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚  method: "upi"                  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Updates
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ORDER STATUS UPDATE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  paymentStatus: "pending" â†’ "paid"                        â”‚  â”‚
â”‚  â”‚  status: "placed" (unchanged, fulfillment separate)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SECURITY LAYERS                            â”‚
â”‚                                                                 â”‚
â”‚  1. AMOUNT INTEGRITY                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ Frontend: NEVER sends amount                    â”‚        â”‚
â”‚     â”‚ Backend:  ALWAYS calculates from Order          â”‚        â”‚
â”‚     â”‚ Result:   Tamper-proof payment amounts          â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                      â”‚
â”‚  2. SIGNATURE VERIFICATION                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ Razorpay: Signs response with HMAC SHA256       â”‚        â”‚
â”‚     â”‚ Backend:  Verifies signature with secret key    â”‚        â”‚
â”‚     â”‚ Result:   Prevents fake payment confirmations   â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                      â”‚
â”‚  3. WEBHOOK VERIFICATION                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ Razorpay: Signs webhook with separate secret    â”‚        â”‚
â”‚     â”‚ Backend:  Verifies webhook signature            â”‚        â”‚
â”‚     â”‚ Result:   Prevents fake webhook attacks         â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                      â”‚
â”‚  4. IDEMPOTENCY                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ Check:    Payment already processed?            â”‚        â”‚
â”‚     â”‚ Action:   Skip if already done                  â”‚        â”‚
â”‚     â”‚ Result:   Prevents duplicate confirmations      â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                      â”‚
â”‚  5. AUTHORIZATION                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ Verify:   Order belongs to buyer                â”‚        â”‚
â”‚     â”‚ Check:    User is authenticated                 â”‚        â”‚
â”‚     â”‚ Result:   Prevents unauthorized access          â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ”„ Status Transitions

```
ORDER STATUS FLOW:
placed â”€â”€> confirmed â”€â”€> shipped â”€â”€> delivered
   â”‚                                      â–²
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€> cancelled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PAYMENT STATUS FLOW:
created â”€â”€> authorized â”€â”€> paid â”€â”€> refunded
   â”‚                         â–²
   â””â”€â”€â”€â”€â”€â”€â”€â”€> failed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COMBINED ORDER & PAYMENT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order Status   â”‚ Payment Status  â”‚ Action               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ placed         â”‚ pending         â”‚ Awaiting payment     â”‚
â”‚ placed         â”‚ paid            â”‚ Ready to confirm     â”‚
â”‚ confirmed      â”‚ paid            â”‚ Ready to ship        â”‚
â”‚ shipped        â”‚ paid            â”‚ In transit           â”‚
â”‚ delivered      â”‚ paid            â”‚ Complete             â”‚
â”‚ cancelled      â”‚ paid            â”‚ Initiate refund      â”‚
â”‚ cancelled      â”‚ refunded        â”‚ Complete with refund â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸŽ¯ Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ERROR SCENARIOS                             â”‚
â”‚                                                                 â”‚
â”‚  CREATE PAYMENT                                                 â”‚
â”‚     â”œâ”€ Order not found â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 404 "Order not found"     â”‚
â”‚     â”œâ”€ Already paid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 400 "Order already paid"  â”‚
â”‚     â”œâ”€ Order cancelled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 400 "Order cancelled"     â”‚
â”‚     â”œâ”€ Unauthorized â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 403 "Not your order"      â”‚
â”‚     â””â”€ Razorpay error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 500 "Failed to create"    â”‚
â”‚                                                                 â”‚
â”‚  VERIFY PAYMENT                                                 â”‚
â”‚     â”œâ”€ Payment not found â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 404 "Payment not found"   â”‚
â”‚     â”œâ”€ Invalid signature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 400 "Invalid signature"   â”‚
â”‚     â”œâ”€ Already processed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 200 "Already verified"    â”‚
â”‚     â””â”€ Not captured on Razorpay â”€â”€â”€> 400 "Not captured"        â”‚
â”‚                                                                 â”‚
â”‚  WEBHOOK                                                        â”‚
â”‚     â”œâ”€ Missing signature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 400 "Signature missing"   â”‚
â”‚     â”œâ”€ Invalid signature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 400 "Invalid signature"   â”‚
â”‚     â”œâ”€ Payment not found â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 200 "Payment not found"   â”‚
â”‚     â””â”€ Processing error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 200 "Logged for review"   â”‚
â”‚                                                                 â”‚
â”‚  NOTE: Webhooks always return 200 to prevent retries           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“‚ Module Structure

```
payments/
â”‚
â”œâ”€â”€ routes.js               # HTTP Layer
â”‚   â”œâ”€ POST /create        # Create payment
â”‚   â”œâ”€ POST /verify        # Verify payment
â”‚   â”œâ”€ GET /:id            # Get payment
â”‚   â”œâ”€ GET /               # List payments
â”‚   â””â”€ POST /webhook       # Webhook handler
â”‚
â”œâ”€â”€ service.js             # Business Logic
â”‚   â”œâ”€ createPaymentForOrder()
â”‚   â”œâ”€ verifyPayment()
â”‚   â”œâ”€ handleWebhook()
â”‚   â”œâ”€ processRefund()
â”‚   â”œâ”€ getPaymentById()
â”‚   â””â”€ listPaymentsForUser()
â”‚
â”œâ”€â”€ validator.js           # Input Validation
â”‚   â”œâ”€ createPaymentSchema
â”‚   â”œâ”€ verifyPaymentSchema
â”‚   â”œâ”€ refundSchema
â”‚   â””â”€ listPaymentsSchema
â”‚
â”œâ”€â”€ razorpay.client.js     # Razorpay SDK
â”‚   â”œâ”€ createRazorpayOrder()
â”‚   â”œâ”€ verifyPaymentSignature()
â”‚   â”œâ”€ verifyWebhookSignature()
â”‚   â”œâ”€ fetchPaymentDetails()
â”‚   â””â”€ initiateRefund()
â”‚
â””â”€â”€ README.md              # Documentation
```

## ðŸ”„ Idempotency Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDEMPOTENCY CHECKS                           â”‚
â”‚                                                                 â”‚
â”‚  VERIFY PAYMENT CALL 1:                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚ 1. Check payment status                     â”‚            â”‚
â”‚     â”‚    â””â”€> status = "created"                   â”‚            â”‚
â”‚     â”‚ 2. Verify signature                         â”‚            â”‚
â”‚     â”‚    â””â”€> Valid âœ“                              â”‚            â”‚
â”‚     â”‚ 3. Update status to "paid"                  â”‚            â”‚
â”‚     â”‚ 4. Update Order.paymentStatus               â”‚            â”‚
â”‚     â”‚ 5. Return success                           â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  VERIFY PAYMENT CALL 2 (duplicate):                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚ 1. Check payment status                     â”‚            â”‚
â”‚     â”‚    â””â”€> status = "paid" â—„â”€â”€â”€ ALREADY DONE   â”‚            â”‚
â”‚     â”‚ 2. Return success immediately               â”‚            â”‚
â”‚     â”‚    â””â”€> "Already verified"                   â”‚            â”‚
â”‚     â”‚ 3. NO duplicate database updates            â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  RESULT: Same effect regardless of how many times called        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**These diagrams illustrate the complete payment architecture. Refer to README.md for detailed explanations.**
